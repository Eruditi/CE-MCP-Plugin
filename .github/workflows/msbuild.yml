name: Build CE-MCP-Plugin

on:
  push:
    branches: [ main, master, CE-MCP-Plugin ]
  pull_request:
    branches: [ main, master, CE-MCP-Plugin ]
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build Configuration'
        required: true
        default: 'Release'
        type: choice
        options:
        - Release
        - Debug
      platform:
        description: 'Build Platform'
        required: true
        default: 'Win32'
        type: choice
        options:
        - Win32
        - x64

jobs:
  build:
    runs-on: windows-latest
    
    env:
      SOLUTION_FILE_PATH: CE-MCP-Plugin.sln
      BUILD_CONFIGURATION: ${{ github.event.inputs.configuration || 'Release' }}
      BUILD_PLATFORM: ${{ github.event.inputs.platform || 'Win32' }}
      VISUAL_STUDIO_VERSION: '17.0' # Visual Studio 2022

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      with:
        vs-version: ${{ env.VISUAL_STUDIO_VERSION }}
        msbuild-architecture: ${{ env.BUILD_PLATFORM }}

    - name: Download Lua 5.3 libraries
      shell: pwsh
      run: |
        $workspace = $env:GITHUB_WORKSPACE
        $libsDir = Join-Path $workspace 'libs'
        if (-not (Test-Path $libsDir)) { New-Item -ItemType Directory -Path $libsDir | Out-Null }

        Write-Host 'Downloading Lua 5.3 Win32 library from cheat-engine repository...'
        Invoke-WebRequest -Uri 'https://raw.githubusercontent.com/badeesindi/cheat-engine/master/cheat-engine/cheatengine/bin/lua_extra/lua53-32.lib' -OutFile (Join-Path $libsDir 'lua53-32.lib') -UseBasicParsing
        
        Write-Host 'Downloading Lua 5.3 x64 library from cheat-engine repository...'
        Invoke-WebRequest -Uri 'https://raw.githubusercontent.com/badeesindi/cheat-engine/master/cheat-engine/cheatengine/bin/lua_extra/lua53-64.lib' -OutFile (Join-Path $libsDir 'lua53-64.lib') -UseBasicParsing

        # Validate downloaded files
        if (-not (Test-Path (Join-Path $libsDir 'lua53-32.lib'))) { Write-Error "Failed to download lua53-32.lib"; exit 1 }
        if (-not (Test-Path (Join-Path $libsDir 'lua53-64.lib'))) { Write-Error "Failed to download lua53-64.lib"; exit 1 }

        Write-Host 'libs content:'
        Get-ChildItem -Path $libsDir -Force | Format-Table Name,Length

    - name: Build solution
      run: msbuild ${{ env.SOLUTION_FILE_PATH }} /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform=${{ env.BUILD_PLATFORM }} /p:BuildProjectReferences=true /p:RestorePackagesConfig=true /verbosity:minimal
      shell: cmd
      working-directory: ${{ github.workspace }}

    - name: List build output
      run: |
        if ('${{ env.BUILD_PLATFORM }}' -eq 'x64') {
          ls -la ${{ env.BUILD_PLATFORM }}\${{ env.BUILD_CONFIGURATION }}
        } else {
          ls -la ${{ env.BUILD_CONFIGURATION }}
        }
      working-directory: ${{ github.workspace }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CE-MCP-Plugin-${{ env.BUILD_PLATFORM }}-${{ env.BUILD_CONFIGURATION }}
        path: |
          ${{ env.BUILD_PLATFORM }}/${{ env.BUILD_CONFIGURATION }}/CE-MCP-Plugin.dll
          ${{ env.BUILD_CONFIGURATION }}/CE-MCP-Plugin.dll
        retention-days: 30
