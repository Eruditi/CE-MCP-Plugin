name: Build CE-MCP-Plugin

on:
  push:
    branches: [ main, master, CE-MCP-Plugin ]
  pull_request:
    branches: [ main, master, CE-MCP-Plugin ]
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build Configuration'
        required: true
        default: 'Release'
        type: choice
        options:
        - Release
        - Debug
      platform:
        description: 'Build Platform'
        required: true
        default: 'Win32'
        type: choice
        options:
        - Win32
        - x64

jobs:
  build:
    runs-on: windows-latest
    
    env:
      SOLUTION_FILE_PATH: CE-MCP-Plugin.sln
      BUILD_CONFIGURATION: ${{ github.event.inputs.configuration || 'Release' }}
      BUILD_PLATFORM: ${{ github.event.inputs.platform || 'Win32' }}
      VISUAL_STUDIO_VERSION: '17.0' # Visual Studio 2022

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      with:
        vs-version: ${{ env.VISUAL_STUDIO_VERSION }}
        msbuild-architecture: ${{ env.BUILD_PLATFORM }}

    - name: Download Lua 5.3 libraries
      run: |
        mkdir -p libs
        # Download Lua 5.3.6 Win32 static library
        curl -L -o lua53-win32.zip "https://sourceforge.net/projects/luabinaries/files/5.3.6/Windows%20Libraries/Static/lua-5.3.6_Win32_lib.zip/download"
        # Download Lua 5.3.6 x64 static library
        curl -L -o lua53-x64.zip "https://sourceforge.net/projects/luabinaries/files/5.3.6/Windows%20Libraries/Static/lua-5.3.6_Win64_lib.zip/download"
        # Extract libraries
        powershell -Command "Expand-Archive -Path lua53-win32.zip -DestinationPath lua53-win32 -Force"
        powershell -Command "Expand-Archive -Path lua53-x64.zip -DestinationPath lua53-x64 -Force"
        # Copy lib files to libs directory
        cp lua53-win32/lib/*.lib libs/
        cp lua53-x64/lib/*.lib libs/
        # Rename libraries to match project expectations
        cd libs
        mv lua53.lib lua53-32.lib
        # For x64, we need to check if there's a separate file or use the same
        # LuaBinaries provides lua53.lib for both, we'll create a copy for x64
        cp lua53-32.lib lua53-64.lib
        cd ..
      shell: cmd

    - name: Build solution
      run: msbuild ${{ env.SOLUTION_FILE_PATH }} /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform=${{ env.BUILD_PLATFORM }} /p:BuildProjectReferences=true /p:RestorePackagesConfig=true /verbosity:minimal
      shell: cmd
      working-directory: ${{ github.workspace }}

    - name: List build output
      run: |
        if ('${{ env.BUILD_PLATFORM }}' -eq 'x64') {
          ls -la ${{ env.BUILD_PLATFORM }}\${{ env.BUILD_CONFIGURATION }}
        } else {
          ls -la ${{ env.BUILD_CONFIGURATION }}
        }
      working-directory: ${{ github.workspace }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CE-MCP-Plugin-${{ env.BUILD_PLATFORM }}-${{ env.BUILD_CONFIGURATION }}
        path: |
          ${{ env.BUILD_PLATFORM }}/${{ env.BUILD_CONFIGURATION }}/CE-MCP-Plugin.dll
          ${{ env.BUILD_CONFIGURATION }}/CE-MCP-Plugin.dll
        retention-days: 30
