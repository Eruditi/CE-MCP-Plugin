name: Build CE-MCP-Plugin

on:
  push:
    branches: [ main, master, CE-MCP-Plugin ]
  pull_request:
    branches: [ main, master, CE-MCP-Plugin ]
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build Configuration'
        required: true
        default: 'Release'
        type: choice
        options:
        - Release
        - Debug
      platform:
        description: 'Build Platform'
        required: true
        default: 'Win32'
        type: choice
        options:
        - Win32
        - x64

jobs:
  build:
    runs-on: windows-latest
    
    env:
      SOLUTION_FILE_PATH: CE-MCP-Plugin.sln
      BUILD_CONFIGURATION: ${{ github.event.inputs.configuration || 'Release' }}
      BUILD_PLATFORM: ${{ github.event.inputs.platform || 'Win32' }}
      VISUAL_STUDIO_VERSION: '17.0' # Visual Studio 2022

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      with:
        vs-version: ${{ env.VISUAL_STUDIO_VERSION }}
        msbuild-architecture: ${{ env.BUILD_PLATFORM }}

    - name: Build Lua 5.3 static libraries
      shell: pwsh
      run: |
        $workspace = $env:GITHUB_WORKSPACE
        $libsDir = Join-Path $workspace 'libs'
        $luaSrcDir = Join-Path $env:RUNNER_TEMP 'lua-5.3.6'
        $luaSrcZip = Join-Path $env:RUNNER_TEMP 'lua-5.3.6.tar.gz'
        
        if (-not (Test-Path $libsDir)) { New-Item -ItemType Directory -Path $libsDir | Out-Null }
        if (-not (Test-Path $luaSrcDir)) { New-Item -ItemType Directory -Path $luaSrcDir | Out-Null }
        
        Write-Host 'Downloading Lua 5.3.6 source code...'
        Invoke-WebRequest -Uri 'https://www.lua.org/ftp/lua-5.3.6.tar.gz' -OutFile $luaSrcZip -UseBasicParsing
        tar -xzf $luaSrcZip -C $env:RUNNER_TEMP
        
        Write-Host 'Building Lua 5.3.6 for Win32...'
        $luaSrcPath = Join-Path $env:RUNNER_TEMP 'lua-5.3.6\src'
        Push-Location $luaSrcPath
        
        # Find Visual Studio installation
        $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
        if (Test-Path $vswhere) {
          $vsPath = & $vswhere -latest -property installationPath
          $vcvars32 = Join-Path $vsPath 'VC\Auxiliary\Build\vcvars32.bat'
          $vcvars64 = Join-Path $vsPath 'VC\Auxiliary\Build\vcvars64.bat'
        } else {
          # Fallback to common paths
          $vcvars32 = "${env:ProgramFiles}\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars32.bat"
          $vcvars64 = "${env:ProgramFiles}\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          if (-not (Test-Path $vcvars32)) {
            $vcvars32 = "${env:ProgramFiles}\Microsoft Visual Studio\2022\Professional\VC\Auxiliary\Build\vcvars32.bat"
            $vcvars64 = "${env:ProgramFiles}\Microsoft Visual Studio\2022\Professional\VC\Auxiliary\Build\vcvars64.bat"
          }
          if (-not (Test-Path $vcvars32)) {
            $vcvars32 = "${env:ProgramFiles}\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build\vcvars32.bat"
            $vcvars64 = "${env:ProgramFiles}\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build\vcvars64.bat"
          }
        }
        
        Write-Host "Using vcvars32: $vcvars32"
        Write-Host "Using vcvars64: $vcvars64"
        
        # Build Win32 static library
        cmd /c ('"' + $vcvars32 + '" && cl /MT /O2 /c /DLUA_BUILD_AS_DLL *.c && lib /OUT:lua53-static.lib *.obj && copy lua53-static.lib "' + $libsDir + '\lua53-32.lib"')
        
        # Build x64 static library
        Write-Host 'Building Lua 5.3.6 for x64...'
        cmd /c ('"' + $vcvars64 + '" && cl /MT /O2 /c /DLUA_BUILD_AS_DLL *.c && lib /OUT:lua53-static.lib *.obj && copy lua53-static.lib "' + $libsDir + '\lua53-64.lib"')
        
        Pop-Location
        
        # Validate built files
        if (-not (Test-Path (Join-Path $libsDir 'lua53-32.lib'))) { Write-Error "Failed to build lua53-32.lib"; exit 1 }
        if (-not (Test-Path (Join-Path $libsDir 'lua53-64.lib'))) { Write-Error "Failed to build lua53-64.lib"; exit 1 }
        
        Write-Host 'libs content:'
        Get-ChildItem -Path $libsDir -Force | Format-Table Name,Length

    - name: Build solution
      run: msbuild ${{ env.SOLUTION_FILE_PATH }} /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform=${{ env.BUILD_PLATFORM }} /p:BuildProjectReferences=true /p:RestorePackagesConfig=true /verbosity:minimal
      shell: cmd
      working-directory: ${{ github.workspace }}

    - name: List build output
      shell: pwsh
      run: |
        if ('${{ env.BUILD_PLATFORM }}' -eq 'x64') {
          Get-ChildItem -Path "${{ env.BUILD_PLATFORM }}\${{ env.BUILD_CONFIGURATION }}" -Force | Format-Table Name,Length,LastWriteTime
        } else {
          Get-ChildItem -Path "${{ env.BUILD_CONFIGURATION }}" -Force | Format-Table Name,Length,LastWriteTime
        }
      working-directory: ${{ github.workspace }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CE-MCP-Plugin-${{ env.BUILD_PLATFORM }}-${{ env.BUILD_CONFIGURATION }}
        path: |
          ${{ env.BUILD_PLATFORM }}/${{ env.BUILD_CONFIGURATION }}/CE-MCP-Plugin.dll
          ${{ env.BUILD_CONFIGURATION }}/CE-MCP-Plugin.dll
        retention-days: 30
